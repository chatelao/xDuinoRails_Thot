# RCN-227

## DCC-Protocol

```
Extended Function Mapping
```
```
Date of Issue
02. 12 .2018
```
```
RailCommunity – Association
of Digital Model Railroad
Product Manufacturers
```
## Contents

1 General ............................................................................................................................. 1

```
1.1 Purpose of the Standard ........................................................................................................... 1
1.2 Definition of Terms .......................................................................................................... 1
1.3 Requirements .............................................................................................................. 2
```
2 Function Mapping System with CVs per Function ........................................................... 2

3 Function Mapping System with CVs per Output ........................................................... 3

```
3.1 Version 1: Matrix .......................................................................................................... 3
3.2 Version 2: Function Number ....................................................................................... 3
3.3 Version 3: Function or Binary State Number ...................................................... 4
```
4 Selection of Function Mapping .......................................................................................... 5

Appendix A: References to other Standards .................................................................................. 6

```
A.1 Normative References .................................................................................................... 6
A.2 Informative References ................................................................................................... 6
```
Appendix B: History ..................................................................................................................... 6

## 1 General

### 1.1 Purpose of the Standard

This standard describes an extended system for function mapping between the
functions within the DCC protocol and the outputs of a decoder. This
function mapping system allows for any assignment between up to 32
functions to 24 outputs, thus taking into account the increased number of functions compared to the mapping via
configuration variables 33 to 46.
At the same time, this function mapping is designed so that it can still be managed without a special
configuration program.

### 1.2 Definition of Terms

In this standard, the terms function and output are used as follows:

Functions are the functions defined in the DCC protocol (or any other protocol for
data transmission to the locomotive).


Outputs are the actions controlled by the decoder. These outputs can be
physical function outputs for controlling external loads, but also other
actions such as sounds or changes in driving behavior, e.g., for shunting mode.

CV refers to the Configuration Variables.

### 1.3 Requirements

To comply with this standard, a decoder must support the function mapping system described here
for all functions received via the protocol and all outputs
of the decoder.

However, other function mapping systems may also be supported, e.g., via
configuration variables 33 to 46 or a manufacturer-specific system.

Configuration variable 96 must be supported as described in [RCN225].

## 2 Function Mapping System with CVs per Function

To have sufficient memory space available, a block of 256 CVs selected via CVs 31 and 32
is used, which are then accessible via CVs 257 to 512. To select the block for function mapping,
CV 31 must be set to the value 0 and CV 32 to the value 40.

Four bytes are reserved for each function and direction. I.e., for function F0 forward
CVs 257 to 260, for F0 reverse CVs 261 to 264, for F1 forward CVs 265 to
268, for F1 reverse CVs 269 to 272, etc.

Each set bit links an output with a function. The first three bytes per
function and direction activate outputs 1 to 24, where output 1 is controlled by bit 0 of the
first byte and output 24 by bit 7 of the third byte. If an output is
controlled by multiple functions, they are OR-linked, i.e., the output is
active when one or more functions control this output.

The fourth byte per function and direction defines a function that prevents the activation of
the outputs via this function and direction. The number of the
function – i.e., 0 for F0, 1 for F1, 2 for F2, etc. – is entered. A value of 255 means that
no function prevents activation.


## 3 Function Mapping System with CVs per Output

### 3.1 Version 1: Matrix

To have sufficient memory space available, a block of 256 CVs selected via CVs 31 and 32
is used, which are then accessible via CVs 257 to 512. To select the block for function mapping,
CV 31 must be set to the value 0 and CV 32 to the value 41.

Four bytes are reserved for each output and direction of travel. I.e., for output A forward
CVs 257 to 260, for output A reverse CVs 261 to 264, for output B forward
CVs 265 to 268, for output B reverse CVs 269 to 272, etc.

Each set bit links an output with a function. Bits 0
to 7 of the first byte correspond to functions F0 to F7, those of the second byte to F8 to F15, those of the
third byte to F16 to F23, and those of the fourth byte to F24 to F31.

This allows each of the maximum 32 outputs to be controlled by any number of functions.
However, control via binary states or blocking an output is
not possible.

### 3.2 Version 2: Function Number

To have sufficient memory space available, a block of 256 CVs selected via CVs 31 and 32
is used, which are then accessible via CVs 257 to 512. To select the block for function mapping,
CV 31 must be set to the value 0 and CV 32 to the value 42.

Four bytes are reserved for each output and direction of travel. I.e., for output A forward
CVs 257 to 260, for output A reverse CVs 261 to 264, for output B forward
CVs 265 to 268, for output B reverse CVs 269 to 272, etc.

Each byte contains a function number. If the number is greater than 28 (may need to be adjusted to
68), this number is interpreted as a binary state. The value 255 indicates an
inactive byte. The first three bytes switch the output on. The fourth byte switches the
output off regardless of the state of other functions.

This allows each of the maximum 32 outputs to be controlled by up to four functions or binary states
up to binary state 254. Since no bitmasks need to be calculated, this
system should be particularly simple for the user.

Example:
Light control on a diesel or electric locomotive. The following logic should be achieved:

a. "normal" light change via F0
b. Because this is not prototypical with a train: F1 blocks the lights on driver's cab 1, F2 blocks
the lights on driver's cab 2.
c. The shunting mode via F6 should also switch on both white lights and the red lights
off.
d. Function F23 should switch on "parking light" with red on both sides.


Programming:

a) b) & c) --- d)

Output white 1 fwd. CV257 = F0 = 0 CV258 = F6 = 6 CV259 = 255 CV260 = F1 = 1

Output white 1 rev. CV261 = 255 CV262 = F6 = 6 CV263 = 255 CV260 = F1 = 1

Output white 2 fwd. CV265 = 255 CV266 = F6 = 6 CV267 = 255 CV268 = F2 = 2

Output white 2 rev. CV269 = F0 = 0 CV270 = F6 = 6 CV271 = 255 CV268 = F2 = 2

Output red 1 fwd. CV273 = 255 CV274 = F23 = 23 CV275 = 255 CV275 = F1 = 1

Output red 1 rev. CV277 = F0 = 0 CV274 = F23 = 23 CV279 = 255 CV275 = F1 = 1

Output red 2 fwd. CV281 = F0 = 0 CV282 = F23 = 23 CV283 = 255 CV284 = F2 = 2

Output red 2 rev. CV285 = 255 CV282 = F23 = 23 CV287 = 255 CV288 = F2 = 2

Problem: For shunting mode and "parking light", the other functions must be switched off.

### 3.3 Version 3: Function or Binary State Number

To have sufficient memory space available, a block of 256 CVs selected via CVs 31 and 32
is used, which are then accessible via CVs 257 to 512. To select the block for function mapping,
CV 31 must be set to the value 0 and CV 32 to the value 43.

Eight bytes are reserved for each output. I.e., for output A CVs 257 to 264, for
output B CVs 265 to 272, for output C CVs 273 to 280, etc.

The first four bytes denote a function and direction. The function number
0 - 63 is stored in bits 0 to 5. The directional dependence is defined in bits 6 and 7 as
follows:

```
Bit
7
```
```
Bit
6
```
```
Calculation Rule Action
```
```
0 0 Function number Function acts regardless of direction
```
```
0 1 Function number + 64 Function acts only forwards
```
```
1 0 Function number + 128 Function acts only backwards
```
```
1 1 Function number + 192
```
```
Function blocks the output regardless of the
state of other functions
```
The value 255 indicates an inactive byte.

The second four bytes contain two byte-pairs, with which either functions or
binary state controls can be selected. In the first of the two bytes are the
higher 7 bits of the number of the function or binary state control, in the second
byte the 8 lower bits are stored. Numbers up to 28 inclusive (may need to be adjusted to
68) denote functions, values above that denote binary state controls. The
most significant bit (bit 7) in the first byte is set if this function or
binary state control is to block the output. Controls via the two byte-
pairs in the second four bytes always operate independently of direction.

If both bytes of a pair have the value 255, this byte-pair is inactive.

This allows each of the maximum 32 outputs to be controlled by up to six functions or binary states
up to binary state 32767. Blocking the output via binary state
32767 is not possible. Also, there is no directional dependence of the binary states.

Example:
Light control on a diesel or electric locomotive. The following logic should be achieved:

a. "normal" light change via F0
b. Because this is not prototypical with a train: F1 blocks the lights on driver's cab 1, F2 blocks
the lights on driver's cab 2.
c. The shunting mode via F6 should also switch on both white lights and the red lights
off.
d. Function F23 should switch on "parking light" with red on both sides.

Programming:

a) b) c) d)

Output white

1

CV257 =

F0 + 64 = 64

CV258 =

F1 + 192 = 193

CV259 =

F6 = 6

CV260 =

F23 + 192 = 215

Output white
2

CV265 =

F0 + 128 = 128

CV266 =

F2 + 192 = 194

CV267 =

F6 = 6

CV268 =

F23 + 192 = 215

Output red 1

CV273 =

F0 + 128 = 128

CV274 =

F1 + 192 = 193

CV275 =

F6 + 192 = 198

CV275 =

F23 = 23

Output red 2

CV281 =

F0 + 64 = 64

CV282 =

F2 + 192 = 194

CV283 =

F6 + 192 = 198

CV284 =

F23 = 23

The unlisted CVs between CV261 and CV288 have the value 255.

It can be seen that there is only a directional dependence in the first byte. Problem:
For "parking", the shunting mode must be disengaged, otherwise it remains dark. Likewise,
F1 and F2 should be switched off for shunting mode and "parking light". These problems
could be solved by having a switch-off only affect the preceding bytes. But then
the order of the bytes would no longer be arbitrary.

## 4 Selection of Function Mapping

If multiple function mapping systems are implemented in a decoder, the
user can select the desired system via the configuration variable CV 96 as specified in [RCN225].


## Appendix A: References to other Standards

### A.1 Normative References

The standard listed here must be adhered to in whole or to the extent specified in the citation
to comply with this standard.

[RCN225] RCN-225 DCC Configuration Variables

### A.2 Informative References

The standards and documents listed here are for informational purposes only and are
not part of this standard.

## Appendix B: History

```
Date Chapter Changes compared to the previous version
```
02.12.2018 All First version

Copyright 2018 RailCommunity – Association of Digital Model Railroad Product Manufacturers e.V.
